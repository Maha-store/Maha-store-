import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query } from 'firebase/firestore';
import { 
  Zap, X, CreditCard, Globe, RefreshCw, ShoppingBag, 
  CheckCircle, MapPin, Languages, PlaneTakeoff, 
  ShieldCheck, Sparkles, ArrowUpRight, Activity,
  Target, Repeat, TrendingUp, MousePointer2
} from 'lucide-react';

// إعدادات البيئة (سيتم تعويضها آلياً من البيئة)
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'neo-pulse-ultimate-core';

const App = () => {
  const [user, setUser] = useState(null);
  const [cart, setCart] = useState([]);
  const [logs, setLogs] = useState([]);
  const [isCartOpen, setIsCartOpen] = useState(false);
  const [processingStatus, setProcessingStatus] = useState('idle');
  
  // الحالة العالمية (اللغة، المنطقة، الإحصائيات)
  const [lang, setLang] = useState('ar'); 
  const [region, setRegion] = useState({ name: 'Middle East', currency: 'SAR', symbol: 'ر.س', rate: 3.75 });
  const [stats, setStats] = useState({ 
    visitors: 0, 
    tracked: 0, 
    recovered: 0, 
    conversions: 0,
    sources: { tiktok: 0, snapchat: 0, insta: 0 }
  });

  // قاموس الترجمة الشامل
  const translations = {
    ar: {
      brand: "NEO-PULSE",
      slogan: "النبض العالمي للتجارة الذكية",
      hero: "اكتسح الأسواق بنظام NEO المتطور",
      subHero: "نظام ذكاء اصطناعي موحد يربطك بأقل أسعار الموردين عالمياً مع شحن عابر للقارات وملاحقة ذكية للزبائن.",
      addCart: "خطف الآن",
      checkout: "إتمام الدفع الآمن",
      total: "المجموع الكلي",
      saving: "وفرت مع NEO",
      secure: "حماية Stripe نشطة",
      products: ["سترة نيو-تيك السوداء", "طقم الحركة الذكية", "حقيبة النبض الرقمي"],
      radar: "رادار العمليات العالمية",
      recoveredLabel: "مبيعات مستردة",
      trackedLabel: "زوار تحت الملاحقة"
    },
    en: {
      brand: "NEO-PULSE",
      slogan: "The Global Pulse of Smart Commerce",
      hero: "Dominate Markets with NEO Core",
      subHero: "Unified AI system linking you to factory prices globally with transcontinental shipping and smart retargeting.",
      addCart: "Snatch Now",
      checkout: "Secure Checkout",
      total: "Total Amount",
      saving: "Saved with NEO",
      secure: "Stripe Protection Active",
      products: ["Neo-Tech Stealth Jacket", "Smart Motion Set", "Digital Pulse Pack"],
      radar: "Global Ops Radar",
      recoveredLabel: "Recovered Sales",
      trackedLabel: "Tracked Visitors"
    },
    fr: {
      brand: "NEO-PULSE",
      slogan: "Le Pouls Mondial du Commerce Intelligent",
      hero: "Dominez les Marchés avec NEO Core",
      subHero: "Système IA unifié vous connectant aux prix d'usine mondiaux avec expédition transcontinentale.",
      addCart: "Acheter Maintenant",
      checkout: "Paiement Sécurisé",
      total: "Montant Total",
      saving: "Économisé avec NEO",
      secure: "Protection Stripe Active",
      products: ["Veste furtive Neo-Tech", "Ensemble de mouvement", "Sac à dos Digital Pulse"],
      radar: "Radar des Opérations",
      recoveredLabel: "Ventes Récupérées",
      trackedLabel: "Visiteurs Suivis"
    }
  };

  const t = translations[lang];

  useEffect(() => {
    // 1. نظام المصادقة
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInAnonymously(auth);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    const unsubscribeAuth = onAuthStateChanged(auth, setUser);

    // 2. محاكاة حركة الزوار والبيانات الضخمة
    const dataInterval = setInterval(() => {
      setStats(prev => ({
        ...prev,
        visitors: prev.visitors + 1,
        tracked: prev.tracked + (Math.random() > 0.8 ? 1 : 0),
        sources: {
          tiktok: prev.sources.tiktok + (Math.random() > 0.7 ? 1 : 0),
          snapchat: prev.sources.snapchat + (Math.random() > 0.8 ? 1 : 0),
          insta: prev.sources.insta + (Math.random() > 0.9 ? 1 : 0)
        }
      }));
    }, 3000);

    addLog("نظام NEO: تم تشغيل المحرك الموحد بنجاح.");
    addLog("اللوجستيات: ربط مخازن الصين، أوروبا، وأمريكا.");
    
    return () => {
      unsubscribeAuth();
      clearInterval(dataInterval);
    };
  }, []);

  const addLog = (msg) => {
    const time = new Date().toLocaleTimeString();
    setLogs(prev => [`[${time}] ${msg}`, ...prev].slice(0, 12));
  };

  const products = [
    { id: "p1", basePrice: 75, img: "https://images.unsplash.com/photo-1550009158-9ebf69173e03?w=800" },
    { id: "p2", basePrice: 52, img: "https://images.unsplash.com/photo-1539185441755-769473a23570?w=800" },
    { id: "p3", basePrice: 44, img: "https://images.unsplash.com/photo-1622560480605-d83c853bc5c3?w=800" }
  ];

  const getPrice = (base) => (base * (region.currency === 'SAR' ? 3.75 : region.currency === 'EUR' ? 0.92 : 1)).toFixed(0);

  const handleCheckout = async () => {
    if (!user) return;
    setProcessingStatus('processing');
    addLog(`Stripe: جاري معالجة ${region.currency}...`);
    
    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), {
        userId: user.uid,
        items: cart,
        total: cart.reduce((s, i) => s + parseFloat(getPrice(i.basePrice)), 0),
        currency: region.currency,
        region: region.name,
        timestamp: serverTimestamp()
      });
      
      setTimeout(() => {
        setProcessingStatus('success');
        setStats(prev => ({ ...prev, conversions: prev.conversions + 1, recovered: prev.recovered + (Math.random() > 0.5 ? 1 : 0) }));
        addLog("تمت العملية: شحن آلي قيد التنفيذ.");
        setTimeout(() => {
          setCart([]);
          setIsCartOpen(false);
          setProcessingStatus('idle');
        }, 2000);
      }, 1500);
    } catch (e) {
      addLog("خطأ في الربط السحابي.");
      setProcessingStatus('idle');
    }
  };

  return (
    <div className={`min-h-screen bg-[#000] text-slate-100 font-sans selection:bg-blue-500/30 ${lang === 'ar' ? 'rtl' : 'ltr'}`} dir={lang === 'ar' ? 'rtl' : 'ltr'}>
      
      {/* NEO HUD - وحدة التحكم الجانبية */}
      <div className={`fixed top-28 ${lang === 'ar' ? 'left-6' : 'right-6'} z-[90] w-80 hidden 2xl:block`}>
        <div className="bg-slate-900/40 backdrop-blur-3xl border border-white/5 rounded-[2.5rem] p-6 shadow-2xl">
          <div className="flex items-center gap-2 mb-6">
            <Activity className="w-4 h-4 text-blue-500 animate-pulse" />
            <span className="text-[10px] font-black uppercase tracking-[0.2em] text-blue-400">{t.radar}</span>
          </div>

          <div className="grid grid-cols-2 gap-3 mb-6">
            <div className="bg-black/40 p-3 rounded-2xl border border-white/5">
              <p className="text-[8px] text-slate-500 font-bold uppercase">{t.trackedLabel}</p>
              <p className="text-xl font-black text-white">{stats.tracked}</p>
            </div>
            <div className="bg-black/40 p-3 rounded-2xl border border-white/5 text-green-500">
              <p className="text-[8px] text-slate-500 font-bold uppercase">{t.recoveredLabel}</p>
              <p className="text-xl font-black">{stats.recovered}</p>
            </div>
          </div>

          <div className="space-y-2 mb-6">
             <div className="flex justify-between items-center text-[9px] font-bold">
                <span className="text-slate-500">TIKTOK TRAFFIC</span>
                <span className="text-blue-400">{stats.sources.tiktok}</span>
             </div>
             <div className="w-full h-1 bg-white/5 rounded-full overflow-hidden">
                <div className="h-full bg-blue-500" style={{ width: `${(stats.sources.tiktok / 50) * 100}%` }}></div>
             </div>
          </div>

          <div className="h-32 overflow-hidden text-[9px] font-mono text-slate-500 space-y-1.5 border-t border-white/5 pt-4">
            {logs.map((l, i) => <div key={i} className="truncate">{'>'} {l}</div>)}
          </div>
        </div>
      </div>

      {/* Navigation */}
      <nav className="h-24 sticky top-0 z-[100] bg-black/70 backdrop-blur-2xl border-b border-white/5 px-8 flex items-center justify-between">
        <div className="flex items-center gap-4">
          <div className="w-12 h-12 bg-gradient-to-tr from-blue-600 to-blue-800 rounded-2xl flex items-center justify-center shadow-xl shadow-blue-500/20">
            <Zap className="w-7 h-7 text-white" />
          </div>
          <div>
            <h1 className="text-2xl font-black tracking-tighter text-white">{t.brand}</h1>
            <p className="text-[8px] text-blue-500 font-black uppercase tracking-[0.3em]">{t.slogan}</p>
          </div>
        </div>

        <div className="flex items-center gap-4 md:gap-8">
          <div className="hidden lg:flex gap-2">
            {[
              {n: 'USA', c:'USD', s:'$', l:'en'},
              {n: 'EU', c:'EUR', s:'€', l:'fr'},
              {n: 'ME', c:'SAR', s:'ر.س', l:'ar'}
            ].map(r => (
              <button 
                key={r.n}
                onClick={() => {setRegion({name:r.n, currency:r.c, symbol:r.s, rate:1}); setLang(r.l); addLog(`تحويل: ${r.n}`);}}
                className={`px-3 py-1.5 rounded-lg text-[9px] font-black border transition-all ${region.name === r.n ? 'bg-blue-600 border-blue-400' : 'bg-white/5 border-white/10 text-slate-400'}`}
              >
                {r.n}
              </button>
            ))}
          </div>
          <button onClick={() => setIsCartOpen(true)} className="p-4 bg-white/5 rounded-2xl border border-white/10 relative group">
            <ShoppingBag className="w-6 h-6 text-white group-hover:text-blue-500 transition-colors" />
            {cart.length > 0 && (
              <span className="absolute -top-1 -right-1 bg-blue-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-[10px] font-black border-4 border-black">
                {cart.length}
              </span>
            )}
          </button>
        </div>
      </nav>

      {/* Hero */}
      <main className="relative pt-24 pb-20 px-6">
        <div className="absolute top-0 left-1/2 -translate-x-1/2 w-[90vw] h-[60vh] bg-blue-600/5 blur-[120px] rounded-full -z-10"></div>
        
        <div className="max-w-4xl mx-auto text-center mb-32">
          <div className="inline-flex items-center gap-2 bg-white/5 border border-white/10 px-6 py-2 rounded-full mb-10">
            <Sparkles className="w-4 h-4 text-blue-500 animate-pulse" />
            <span className="text-white text-[10px] font-black uppercase tracking-[0.2em]">{lang === 'ar' ? 'نظام الاكتساح الشامل مفعل' : 'UNIFIED BLITZ SYSTEM ACTIVE'}</span>
          </div>
          <h2 className="text-6xl md:text-9xl font-black mb-10 tracking-tighter leading-[0.9] text-white">
            {t.hero}
          </h2>
          <p className="text-slate-500 text-xl max-w-2xl mx-auto leading-relaxed">
            {t.subHero}
          </p>
        </div>

        {/* Products */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-10 max-w-7xl mx-auto">
          {products.map((p, idx) => (
            <div key={p.id} className="group bg-[#080808] border border-white/5 p-8 rounded-[3.5rem] hover:border-blue-500/30 transition-all duration-700">
              <div className="aspect-[4/5] rounded-[2.5rem] overflow-hidden mb-8 bg-slate-900 shadow-2xl relative">
                <img src={p.img} className="w-full h-full object-cover opacity-60 group-hover:opacity-100 group-hover:scale-110 transition-all duration-1000 grayscale group-hover:grayscale-0" alt={t.products[idx]} />
                <div className="absolute top-6 right-6 bg-blue-600/90 backdrop-blur-md px-4 py-1.5 rounded-full text-[10px] font-black">
                  NEO PRICE
                </div>
              </div>
              <div className="flex justify-between items-end px-2">
                <div>
                  <h3 className="font-black text-xl text-white mb-2">{t.products[idx]}</h3>
                  <p className="text-3xl font-black text-blue-500 tracking-tighter">
                    {getPrice(p.basePrice)} <span className="text-sm opacity-50">{region.symbol}</span>
                  </p>
                </div>
                <button 
                  onClick={() => {
                    setCart([...cart, p]);
                    addLog(`تتبع: العميل أبدى اهتماماً بـ ${t.products[idx]}`);
                  }} 
                  className="p-5 bg-white text-black rounded-3xl hover:bg-blue-600 hover:text-white transition-all shadow-xl active:scale-90"
                >
                  <MousePointer2 className="w-6 h-6" />
                </button>
              </div>
            </div>
          ))}
        </div>
      </main>

      {/* Footer Branding */}
      <footer className="py-20 border-t border-white/5 text-center">
         <div className="flex justify-center gap-8 opacity-20 grayscale mb-8">
            <Globe className="w-8 h-8" />
            <ShieldCheck className="w-8 h-8" />
            <PlaneTakeoff className="w-8 h-8" />
         </div>
         <p className="text-slate-600 text-[10px] font-black uppercase tracking-[0.5em]">NEO-PULSE GLOBAL LOGISTICS CORE</p>
      </footer>

      {/* Enhanced Cart Drawer */}
      <div className={`fixed inset-y-0 ${lang === 'ar' ? 'left-0' : 'right-0'} w-full md:w-[580px] bg-[#020202] border-x border-white/5 z-[200] transition-transform duration-1000 ${isCartOpen ? 'translate-x-0' : (lang === 'ar' ? '-translate-x-full' : 'translate-x-full')}`}>
        <div className="h-full flex flex-col p-14">
          <div className="flex justify-between items-center mb-20 text-white">
            <h3 className="text-5xl font-black italic tracking-tighter uppercase">Cart Hub</h3>
            <button onClick={() => setIsCartOpen(false)} className="p-4 bg-white/5 rounded-2xl hover:text-blue-500 transition-colors"><X className="w-8 h-8" /></button>
          </div>

          <div className="flex-grow space-y-6 overflow-y-auto pr-2 scrollbar-hide">
            {cart.map((item, idx) => (
              <div key={idx} className="flex justify-between items-center p-8 bg-white/5 rounded-[2.5rem] border border-white/5 group">
                <span className="font-black text-xl text-white">{t.products[products.findIndex(pr => pr.id === item.id)]}</span>
                <span className="text-blue-500 font-black text-2xl">{getPrice(item.basePrice)} {region.symbol}</span>
              </div>
            ))}
          </div>

          {cart.length > 0 && (
            <div className="mt-12 space-y-8">
              <div className="flex justify-between items-end px-4">
                <div className="space-y-2">
                  <p className="text-slate-500 text-[10px] font-black uppercase tracking-[0.2em]">{t.total}</p>
                  <p className="text-5xl font-black text-white tracking-tighter">
                    {cart.reduce((s, i) => s + parseFloat(getPrice(i.basePrice)), 0)} <span className="text-lg text-blue-500">{region.symbol}</span>
                  </p>
                </div>
                <div className="bg-green-600/10 px-6 py-4 rounded-3xl border border-green-500/20 text-right">
                  <p className="text-green-500 text-[9px] font-black uppercase mb-1">{t.saving}</p>
                  <p className="text-xl font-black text-green-500">-{ (cart.length * 120).toFixed(0) } {region.symbol}</p>
                </div>
              </div>

              <button 
                onClick={handleCheckout}
                disabled={processingStatus !== 'idle'}
                className="w-full py-9 bg-blue-600 hover:bg-blue-500 rounded-[3rem] font-black text-2xl text-white flex items-center justify-center gap-6 shadow-2xl shadow-blue-600/30 active:scale-95 transition-all disabled:opacity-50"
              >
                {processingStatus === 'idle' ? (
                  <><CreditCard className="w-8 h-8" /> {t.checkout}</>
                ) : processingStatus === 'processing' ? (
                  <><RefreshCw className="w-8 h-8 animate-spin" /> SECURING NODE...</>
                ) : (
                  <><CheckCircle className="w-8 h-8" /> ORDER DEPLOYED</>
                )}
              </button>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

export default App;

